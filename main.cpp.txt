/*----------------------------------------------------------------------------*/
/* */
/* Project:      VEX V5 Learning Portfolio                                 */
/* Author:       Brenda                                      */
/* Created:      Summer 2024                                               */
/* Description:  Integration of Day 1-5 learning tasks from CMA Robotics   */
/* Academy. Demonstrates progression from basic UI to AI.    */
/* */
/*----------------------------------------------------------------------------*/

#include "vex.h"

using namespace vex;

// ---- Hardware Configuration ----
motor LeftDrive = motor(PORT1, ratio18_1, false);
motor RightDrive = motor(PORT10, ratio18_1, true);
drivetrain Drivetrain = drivetrain(LeftDrive, RightDrive, 319.19, 295, 40, mm, 1);

motor ArmMotor = motor(PORT8, ratio18_1, false);
motor ClawMotor = motor(PORT3, ratio18_1, false);

controller Controller1 = controller(primary);
distance FrontSonar = distance(PORT5); 
line LightSensor = line(Brain.ThreeWirePort.A); 
vision VisionSensor = vision(PORT20);

// Vision Signature: BLUE_OBJECT (Calibrated for Day 5 task)
vision::signature BLUE_OBJECT = vision::signature(1, -3463, -2653, -3058, 8359, 10231, 9295, 2.5, 0);

void sys_init(void) {
  vexcodeInit();
  ArmMotor.setVelocity(50, percent);
  ClawMotor.setVelocity(50, percent);
  ClawMotor.setStopping(hold);
}

/* ========================================================================== */
/* DAY 1: Human-Machine Interface (UI)                                        */
/* Focus: Screen coordinate systems and drawing APIs                          */
/* ========================================================================== */
void Day1_Screen_UI() {
  Brain.Screen.clearScreen();
  
  // 1. Identity Information
  Brain.Screen.setCursor(3, 6);
  Brain.Screen.print("Brenda");
  Brain.Screen.setCursor(4, 3);
  Brain.Screen.print("Brenda's School");
  Brain.Screen.newLine();
  Brain.Screen.print("Avengers"); 

  // 2. Geometric Drawing Practice
  Brain.Screen.setPenColor(cyan);
  Brain.Screen.setFillColor(blue);
  Brain.Screen.drawRectangle(10, 10, 200, 70);
  
  Brain.Screen.setPenColor(green);
  Brain.Screen.setFillColor(red);
  Brain.Screen.drawRectangle(15, 15, 500, 90);
  
  Brain.Screen.setPenColor(purple);
  Brain.Screen.setFillColor(orange);
  Brain.Screen.drawCircle(50, 90, 70);

  // 3. Animated Face Drawing
  Brain.Screen.setPenColor(transparent);
  Brain.Screen.setFillColor(yellow);
  Brain.Screen.drawCircle(240, 100, 90); // Head

  // Eye Animation Loop
  for(int i=0; i<3; i++) {
    // Open Eyes
    Brain.Screen.setFillColor(white);
    Brain.Screen.drawCircle(210, 80, 15);
    Brain.Screen.setFillColor(black);
    Brain.Screen.drawCircle(210, 80, 10);
    
    Brain.Screen.setFillColor(white);
    Brain.Screen.drawCircle(270, 80, 15);
    Brain.Screen.setFillColor(black);
    Brain.Screen.drawCircle(270, 80, 10);
    
    wait(1, seconds);
    
    // Blink (Close Eyes)
    Brain.Screen.setFillColor(yellow);
    Brain.Screen.drawCircle(210, 80, 16); 
    Brain.Screen.drawCircle(270, 80, 16);
    wait(0.2, seconds);
  }
}

/* ========================================================================== */
/* DAY 2: Sensor-Based Navigation                                             */
/* Focus: Rangefinders (Sonar) and Timeout Logic                              */
/* ========================================================================== */
void Day2_Auto_Navigation() {
  Brain.Screen.printAt(10, 200, "Day 2: Sonar Obstacle Avoidance");
  
  // Logic: Move forward until Sonar detects object < 200mm
  wait(50, msec);
  
  // While distance is safe (> 200mm) or invalid (-1)
  while(FrontSonar.distance(mm) > 200 || FrontSonar.distance(mm) == -1) {
    Drivetrain.drive(forward);
    wait(20, msec);
  }
  
  // Obstacle detected
  Drivetrain.stop();
  Brain.Screen.printAt(10, 220, "Obstacle Detected: %f mm", FrontSonar.distance(mm));
  
  // Avoidance maneuver (Back up and turn)
  Drivetrain.driveFor(reverse, 500, mm);
  Drivetrain.turnFor(left, 90, degrees);
}

/* ========================================================================== */
/* DAY 3: Tele-operated Control System                                        */
/* Focus: User Input, Timers, and Mechanism Control                           */
/* ========================================================================== */
void Day3_Driver_Control() {
  Brain.Screen.clearScreen();
  Brain.Screen.printAt(10, 100, "Day 3: Driver Control Mode");
  
  Brain.Timer.reset();

  while(true) {
    // 1. Timer Display
    int mytime = Brain.Timer.value() / 1000;
    Controller1.Screen.setCursor(1, 1);
    Controller1.Screen.print("Time: %d s", mytime);

    // 2. Split Arcade Control Logic
    // Axis 3 (Left Y) for Forward/Back, Axis 1 (Right X) for Turn
    int fwd = Controller1.Axis3.position();
    int turn = Controller1.Axis1.position();
    
    LeftDrive.setVelocity(fwd + turn, percent);
    RightDrive.setVelocity(fwd - turn, percent);
    
    if(abs(fwd) > 5 || abs(turn) > 5) {
      LeftDrive.spin(forward);
      RightDrive.spin(forward);
    } else {
      LeftDrive.stop();
      RightDrive.stop();
    }
    
    // 3. Arm & Claw Control (Button Mapping)
    // Claw Logic
    if(Controller1.ButtonR1.pressing()) { 
      ClawMotor.spin(forward); 
    } else if(Controller1.ButtonR2.pressing()) { 
      ClawMotor.spin(reverse); 
    } else { 
      ClawMotor.stop(hold); 
    }

    // Arm Logic
    if(Controller1.ButtonL1.pressing()) { 
      ArmMotor.spin(forward); 
    } else if(Controller1.ButtonL2.pressing()) { 
      ArmMotor.spin(reverse); 
    } else { 
      ArmMotor.stop(hold); 
    }

    wait(20, msec);
  }
}

/* ========================================================================== */
/* DAY 4: Environmental Sensing                                               */
/* Focus: Light Sensor thresholds and Line Tracking                           */
/* ========================================================================== */
void Day4_Line_Tracking() {
  Brain.Screen.printAt(10, 200, "Day 4: Light Sensor Active");
  
  int threshold = 50; // Calibrated grey/white threshold
  
  // Follow line until end
  while(LightSensor.value(pct) > threshold) {
    LeftDrive.spin(forward, 30, percent);
    RightDrive.spin(forward, 30, percent);
    wait(20, msec);
  }
  
  LeftDrive.stop();
  RightDrive.stop();
}

/* ========================================================================== */
/* DAY 5: Computer Vision (AI Foundation)                                     */
/* Focus: Object Recognition, Coordinate Extraction, and Closed-Loop Control  */
/* ========================================================================== */
void Day5_Vision_Tracking() {
  Brain.Screen.clearScreen();
  Brain.Screen.printAt(10, 100, "Day 5: AI Vision (Blue Target)");
  
  while(true) {
    // 1. Data Acquisition
    VisionSensor.takeSnapshot(BLUE_OBJECT);
    
    // 2. Data Processing & Visualization
    if(VisionSensor.largestObject.exists) {
      Brain.Screen.clearScreen();
      Brain.Screen.setCursor(1, 1);
      Brain.Screen.print("Target Detected!");
      Brain.Screen.newLine();
      Brain.Screen.print("X: %d  Y: %d", VisionSensor.largestObject.originX, VisionSensor.largestObject.originY);
      Brain.Screen.newLine();
      Brain.Screen.print("W: %d  H: %d", VisionSensor.largestObject.width, VisionSensor.largestObject.height);
      
      // 3. Logic Control (Centering the Robot)
      int center = 158; 
      int deadband = 20; // Tolerance
      
      if(VisionSensor.largestObject.originX < (center - deadband)) {
        // Target on Left -> Turn Left
        LeftDrive.spin(reverse, 15, percent);
        RightDrive.spin(forward, 15, percent);
      } 
      else if(VisionSensor.largestObject.originX > (center + deadband)) {
        // Target on Right -> Turn Right
        LeftDrive.spin(forward, 15, percent);
        RightDrive.spin(reverse, 15, percent);
      } 
      else {
        // Target Centered -> Move Forward
        LeftDrive.spin(forward, 20, percent);
        RightDrive.spin(forward, 20, percent);
      }
    } 
    else {
      Brain.Screen.printAt(10, 140, "Scanning Environment...");
      LeftDrive.stop();
      RightDrive.stop();
    }
    
    wait(100, msec);
  }
}

int main() {
  sys_init();
  
  // --- Execution Sequence ---
  
  // 1. Start with Day 1 UI
  Day1_Screen_UI();
  wait(2, seconds);
  
  // NOTE: Uncomment specific days below to verify logic independently
  
  // Day2_Auto_Navigation();
  // Day3_Driver_Control();
  // Day4_Line_Tracking();
  
  // 2. Default to Final Project (Day 5 Vision)
  Day5_Vision_Tracking();
}

